stages:
    - services
    - build
    - test
    - deploy

# NGINX PROXY

start_nginx:
    stage: services
    script:
        - docker-compose -f docker-compose.ci.yml up -d nginx-proxy
    rules:
        - if: '$CI_COMMIT_BRANCH == "new-api"'
    

reload_nginx:
    stage: services
    script:
        - docker restart odk-proxy
    rules:
        - if: '$CI_COMMIT_BRANCH == "new-api"'
          changes:
            - nginx.conf

# POSTGRES DATABASE

start_database:
    stage: services
    script:
        - docker-compose -f docker-compose.ci.yml up -d postgres-db
    rules:
        - if: '$CI_COMMIT_BRANCH == "new-api"'
    
# RABBITMQ MESSAGE BROKER

start_rabbitmq:
    stage: services
    script:
        - docker-compose -f docker-compose.ci.yml up -d rabbitmq
    rules:
        - if: '$CI_COMMIT_BRANCH == "new-api"'
    
# FASTAPI SERVER

build_server:
    stage: build
    script:
        - docker-compose -f docker-compose.ci.yml stop fastapi-server
        - docker-compose -f docker-compose.ci.yml build fastapi-server
    rules:
        - if: '$CI_COMMIT_BRANCH == "new-api"'
          changes:
            - docker-compose.ci.yml
            - odk-api/**/*

integration_test_server:
    stage: test
    script:
        - docker-compose -f docker-compose.ci.yml run --rm fastapi-server bash run_db_connection_test.sh
    rules:
        - if: '$CI_COMMIT_BRANCH == "new-api"'
          changes:
            - docker-compose.ci.yml
            - odk-api/**/*


deploy_server:
    stage: deploy
    script:
        - docker-compose -f docker-compose.ci.yml up -d --no-deps fastapi-server
    rules:
        - if: '$CI_COMMIT_BRANCH == "new-api"'
          changes:
            - docker-compose.ci.yml
            - odk-api/**/*

# VUEJS PWA

build_app:
    stage: build
    script:
        - docker-compose -f docker-compose.ci.yml stop vue-pwa
        - docker-compose -f docker-compose.ci.yml build vue-pwa
    rules:
        - if: '$CI_COMMIT_BRANCH == "new-api"'
          changes:
            - docker-compose.ci.yml
            - odk-app/**/*

test_app:
    stage: test
    script:
        - echo "NOT YET IMPLEMENTED"
    rules:
        - if: '$CI_COMMIT_BRANCH == "new-api"'
          changes:
            - docker-compose.ci.yml
            - odk-app/**/*


deploy_app:
    stage: deploy
    script:
        - docker-compose -f docker-compose.ci.yml up -d --no-deps vue-pwa
    rules:
        - if: '$CI_COMMIT_BRANCH == "new-api"'
          changes:
            - docker-compose.ci.yml
            - odk-app/**/*
