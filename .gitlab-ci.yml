stages:
  - services
  - build
  - deploy

# STAGING

staging_start_database:
  stage: services
  tags:
    - staging
  script:
    - docker-compose -f docker-compose.staging.yml up -d db
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging"'

staging_start_rabbitmq:
  stage: services
  tags:
    - staging
  script:
    - docker-compose -f docker-compose.staging.yml up -d rmq
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging"'

staging_build_api:
  stage: build
  tags:
    - staging
  script:
    - docker-compose -f docker-compose.staging.yml stop api
    - docker-compose -f docker-compose.staging.yml build api
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging"'
      changes:
        - docker-compose.staging.yml
        - odk-api/**/*

staging_build_app:
  stage: build
  tags:
    - staging
  script:
    - docker-compose -f docker-compose.staging.yml stop app
    - docker-compose -f docker-compose.staging.yml build app
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging"'
      changes:
        - docker-compose.staging.yml
        - odk-app/**/*

staging_deploy_api:
  stage: deploy
  tags:
    - staging
  script:
    - docker-compose -f docker-compose.staging.yml up -d --no-deps api
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging"'
      changes:
        - docker-compose.staging.yml
        - odk-api/**/*

staging_deploy_app:
  stage: deploy
  tags:
    - staging
  script:
    - docker-compose -f docker-compose.staging.yml up -d --no-deps app
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging"'
      changes:
        - docker-compose.staging.yml
        - odk-app/**/*

# PRODUCTION

## TODO
